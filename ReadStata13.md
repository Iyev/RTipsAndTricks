# Read Stata 13 data file
Benjamin Chan (chanb@ohsu.edu)  
Thursday, September 18, 2014  

Define the function `readStata13`.


```r
readStata13 <- function (fIn) {
  if (Sys.info()["nodename"] == "CHSE") {
    top <- file.path("E:", "Share")
    } else {
      top <- file.path("E:")
      }
  pathApp <- file.path(top, "Applications")
  # Convert from Stata version 13 to version 12
  # Can't use StatTransfer 11; need to convert using Stata 13
  # Create a temporary do file to do this
  tempFileName <- tempfile()
  fOut <- paste0(tempFileName, ".dta")
  fDo <- paste0(tempFileName, ".do")
  fLog <- paste0(tempFileName, ".log")
  lines <- newline(NULL, "capture log close")
  lines <- newline(lines, paste("log using", fLog, ", replace"))
  lines <- newline(lines, paste("use", paste0("\"", fIn, "\""), ", clear"))
  lines <- newline(lines, paste("saveold", paste0("\"", fOut, "\""), ", replace"))
  lines <- newline(lines, "")
  cat(lines, file=fDo)
  # Run Stata in batch mode
  cmd <- paste(file.path(pathApp, "Stata13", "StataMP-64.exe"), "/e do", paste0("\"", fDo, "\""))
  system(cmd, invisible=FALSE)
  # Check the log
  show(readLines(fLog))
  # Then use the foreign package to read the converted version 12 dta file
  require(foreign)
  D <- read.dta(fOut)
  D
}
```

Define some helper functions.


```r
newline <- function (lines, lineToAdd) {
  lines <- paste(lines, lineToAdd, sep="\n")
  lines
}
```

Set file paths.


```r
if (Sys.info()["nodename"] == "CHSE") {
  top <- file.path("E:", "Share")
} else {
  top <- file.path("E:")
}
pathStata <- file.path(top, "Other", "Some code by John", "CCO analyses", "3 Final Data Sets")
```

Read this Stata 13 file.


```r
f <- file.path(pathStata, "quarterly_mcaid_commercial.dta")
```

Try reading the Stata 13 file **without converting** to Stata 12.


```r
require(foreign)
```

```
## Loading required package: foreign
```

```r
D <- read.dta(f)
```

```
## Error: not a Stata version 5-12 .dta file
```

Try reading the Stata 13 file **after converting** to Stata 12.


```r
D <- readStata13(f)
```

```
##  [1] "--------------------------------------------------------------------------------"          
##  [2] "      name:  <unnamed>"                                                                    
##  [3] "       log:  C:\\Users\\chanb\\AppData\\Local\\Temp\\3\\RtmpED8A0p\\file10e4123a19d4.log"  
##  [4] "  log type:  text"                                                                         
##  [5] " opened on:  18 Sep 2014, 09:56:09"                                                        
##  [6] ""                                                                                          
##  [7] ". use \"E:/Share/Other/Some code by John/CCO analyses/3 Final Data Sets/quarterly"         
##  [8] "> _mcaid_commercial.dta\" , clear"                                                         
##  [9] "(Written by R.              )"                                                             
## [10] ""                                                                                          
## [11] ". saveold \"C:\\Users\\chanb\\AppData\\Local\\Temp\\3\\RtmpED8A0p\\file10e4123a19d4.dta\" "
## [12] "> , replace"                                                                               
## [13] "(note: file C:\\Users\\chanb\\AppData\\Local\\Temp\\3\\RtmpED8A0p\\file10e4123a19d4.dta "  
## [14] "> not found)"                                                                              
## [15] "file C:\\Users\\chanb\\AppData\\Local\\Temp\\3\\RtmpED8A0p\\file10e4123a19d4.dta saved"    
## [16] ""                                                                                          
## [17] ". "                                                                                        
## [18] "end of do-file"
```

Check the returned data frame.


```r
str(D)
```

```
## 'data.frame':	20 obs. of  82 variables:
##  $ yearEnding                  : int  17987 18078 18170 18262 18352 18443 18535 18627 18717 18808 ...
##  $ acuteTotalRawComm           : num  NA NA NA NA 173 ...
##  $ acuteTotalRepricedComm      : num  NA NA NA NA 87.4 ...
##  $ expRXImputed                : num  104.8 98.5 98.9 101.6 87.6 ...
##  $ expRXAllowed                : num  102.6 100.9 100.8 98.1 380.5 ...
##  $ expIPComm                   : num  NA NA NA NA 16.4 ...
##  $ expEDComm                   : num  NA NA NA NA 3.25 ...
##  $ expPCPComm                  : num  NA NA NA NA 17.3 ...
##  $ expProceduresComm           : num  NA NA NA NA 21.5 ...
##  $ expTestsComm                : num  NA NA NA NA 6.88 ...
##  $ expImagingComm              : num  NA NA NA NA 10 ...
##  $ expEandMComm                : num  NA NA NA NA 26.9 ...
##  $ hasEDComm                   : num  NA NA NA NA 0.0249 ...
##  $ hasPCPComm                  : num  NA NA NA NA 0.397 ...
##  $ hasIPComm                   : num  NA NA NA NA 0.0144 ...
##  $ acuteTotalRawComm_match     : num  NA NA NA NA 397 ...
##  $ acuteTotalRepricedComm_match: num  NA NA NA NA 182 ...
##  $ expIPComm1                  : num  NA NA NA NA 41.4 ...
##  $ expEDComm1                  : num  NA NA NA NA 9.33 ...
##  $ expPCPComm1                 : num  NA NA NA NA 33.1 ...
##  $ expProceduresComm1          : num  NA NA NA NA 36.3 ...
##  $ expTestsComm1               : num  NA NA NA NA 12.4 ...
##  $ expImagingComm1             : num  NA NA NA NA 21 ...
##  $ expEandMComm1               : num  NA NA NA NA 61.7 ...
##  $ hasEDComm1                  : num  NA NA NA NA 0.0642 ...
##  $ hasPCPComm1                 : num  NA NA NA NA 0.565 ...
##  $ hasIPComm1                  : num  NA NA NA NA 0.0308 ...
##  $ acuteTotalRawMcaid          : num  261 286 300 301 325 ...
##  $ acuteTotalRepricedMcaid     : num  308 322 331 326 350 ...
##  $ expIP                       : num  64.1 68.1 64.4 70.4 79.1 ...
##  $ expIP_BetosExcep            : num  0.08264 0.00895 0.0102 0.01886 0.02453 ...
##  $ expED                       : num  34.7 36.3 37 38.5 39.1 ...
##  $ expPCP                      : num  29 28.9 28.7 27.8 31.5 ...
##  $ expPCPRaw                   : num  26.9 28.9 29.1 28.5 31.6 ...
##  $ expIPRaw                    : num  55.5 62.1 58.4 66.6 76.1 ...
##  $ expProcedures               : num  39.9 41.3 47.6 42 44.6 ...
##  $ expTests                    : num  18.6 18.7 19.2 17.7 19.7 ...
##  $ expImaging                  : num  32.2 32.2 34.9 30.6 33.7 ...
##  $ expEandM                    : num  77.2 78 78.9 79.9 84 ...
##  $ expDME                      : num  8.44 11.51 8.95 9.58 9.72 ...
##  $ expOther                    : num  18 20 21.5 22.4 23.9 ...
##  $ expNA                       : num  66.3 71.5 70.2 73.6 83.1 ...
##  $ expExcep                    : num  47.3 48.5 49.4 50.4 51.1 ...
##  $ expProceduresRaw            : num  34.8 40 44.7 40.2 42.8 ...
##  $ expTestsRaw                 : num  15.9 16.5 18.1 16.4 18.2 ...
##  $ expImagingRaw               : num  27.5 28.6 32.6 29.2 32.6 ...
##  $ expEandMRaw                 : num  66 70.7 74 75.4 80 ...
##  $ expDMERaw                   : num  6.94 9.04 7.37 7.88 8.43 ...
##  $ expOtherRaw                 : num  18.5 20.9 22.5 23.1 24.5 ...
##  $ expNARaw                    : num  57.4 65.9 64.7 70.9 80.5 ...
##  $ expExcepRaw                 : num  34.1 34.9 36.2 37.9 38.1 ...
##  $ expProceduresImp            : num  57.1 58.8 57 52.4 57 ...
##  $ expTestsImp                 : num  18.8 19.2 19.6 18.1 20.1 ...
##  $ expImagingImp               : num  33.8 33.2 35.6 30.9 34 ...
##  $ expEandMImp                 : num  80.4 78.7 79.3 80 84.2 ...
##  $ expDMEImp                   : num  9.91 12.14 9.85 10.26 11.55 ...
##  $ expOtherImp                 : num  16.7 19.4 20.4 24.3 23.5 ...
##  $ expNAImp                    : num  69.3 74.3 73.9 87.6 87.3 ...
##  $ expExcepImp                 : num  75.2 76.1 76.6 73.1 75.4 ...
##  $ expRXEst2                   : num  107 103 101 101 105 ...
##  $ expMH                       : num  67.2 71.1 67.2 68.9 69.4 ...
##  $ expSPMI                     : num  52 54 51.2 49.7 50 ...
##  $ expBH                       : num  86.4 90 87.2 87.4 94.7 ...
##  $ expMH_IP                    : num  14.3 17.3 13.1 15.2 11 ...
##  $ expMH_OP                    : num  14.3 17.3 13.1 15.2 11 ...
##  $ expDetox_IP                 : num  0.357 0.576 0.347 0.246 0.486 ...
##  $ expMH_ED                    : num  2.44 2.95 2.65 2.99 2.77 ...
##  $ expBH_ED                    : num  4.84 5.63 5.19 5.37 5.66 ...
##  $ expMHRaw                    : num  52.5 59 55.3 57.4 57.5 ...
##  $ hasIP                       : num  0.0253 0.0229 0.023 0.0236 0.0271 ...
##  $ hasED                       : num  0.178 0.176 0.177 0.185 0.192 ...
##  $ hasPCP                      : num  0.477 0.474 0.474 0.481 0.509 ...
##  $ hasProc                     : num  0.192 0.204 0.207 0.203 0.206 ...
##  $ hasImage                    : num  0.205 0.194 0.198 0.196 0.211 ...
##  $ hasTest                     : num  0.379 0.38 0.387 0.38 0.408 ...
##  $ hasDME                      : num  0.0932 0.0964 0.0951 0.1115 0.0774 ...
##  $ hasCapitatedPCP             : num  0.894 0.889 0.891 0.893 0.88 ...
##  $ hasCapitated99203           : num  0.864 0.877 0.885 0.892 0.875 ...
##  $ hasCapitatedClaim           : num  0.587 0.593 0.612 0.627 0.618 ...
##  $ hasBH                       : num  0.238 0.237 0.247 0.239 0.26 ...
##  $ quarter                     : num  1 2 3 4 5 6 7 8 9 10 ...
##  $ predictedAcuteMedicaid      : num  310 320 329 339 349 ...
##  - attr(*, "datalabel")= chr "Written by R.              "
##  - attr(*, "time.stamp")= chr "18 Sep 2014 09:56"
##  - attr(*, "formats")= chr  "%td" "%9.0g" "%9.0g" "%9.0g" ...
##  - attr(*, "types")= int  252 255 255 255 255 255 255 255 255 255 ...
##  - attr(*, "val.labels")= chr  "" "" "" "" ...
##  - attr(*, "var.labels")= chr  "yearEnding" "Commercial acute (repriced)" "(mean) amtAllowedImputed" "(mean) expRXImputed" ...
##  - attr(*, "version")= int 12
```
